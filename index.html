<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>AnTI Shop</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body { margin: 0; padding: 0; background: #000; display: flex; justify-content: center; overflow: hidden; font-family: 'Inter', sans-serif; }
#app { width: 392px; height: 100vh; background: #0000; overflow: hidden; position: relative; }

#shopBtn, #backBtn, #settingsBtn, #loginBtn {
  position: absolute;
  top: 12px;
  width: 48px;
  height: 48px;
  background: none;
  border: none;
  padding: 0;
  z-index: 50;
}

#shopBtn { right: 12px; }
#backBtn { right: 12px; display: none; }
#settingsBtn { left: 12px; }
#loginBtn { left: 70px; }

#shopBtn img, #backBtn img, #settingsBtn img, #loginBtn img {
  width: 100%;
  height: 100%;
}

#panels { position: absolute; top: 0; left: 0; width: calc(392px * 2); height: 100%; display: flex; transition: transform 0.55s cubic-bezier(0.35,0.15,0.1,1); }
#clickerPanel, #shopPanel { width: 392px; height: 100%; flex-shrink: 0; }

#clickerPanel { background: linear-gradient(to bottom, #CEEDFF, #A1E6FF); padding-top: 20px; position: relative; overflow: hidden; }
#counter { font-size: 46px; margin: 14px 0; display: flex; justify-content: center; align-items: center; gap: 6px; }
#counter img { width: 32px; height: 32px; object-fit: contain; }

#clickButtonWrapper { position: relative; width: 100%; display: flex; justify-content: center; margin-top: 200px; }
#ground { position: absolute; left: 50%; top: 140px; transform: translateX(-50%); width: 100%; pointer-events: none; z-index: 0; }
#ground img { width: 100%; }

#clickButton { background: none; border: none; z-index: 1; position: relative; }
#clickImg { width: 200px; transition: transform 0.15s ease; -webkit-user-drag: none; touch-action: manipulation; position: relative; z-index: 1; }

#shopPanel { background: linear-gradient(to bottom, #7A4B1D, #5B3F1B); padding-top: 70px; overflow-y: auto; }
#shopPanelInner { background: linear-gradient(to bottom, #FFBA67, #FF7749); margin: 0 auto; padding: 20px; border-radius: 12px; width: 350px; min-height: calc(100vh - 100px); }

.item { width: 300px; height: 180px; background-image: url("img/item-frame.png"); background-size: 100% 100%; padding: 12px; display: flex; flex-direction: column; filter: drop-shadow(0 6px 12px rgba(0,0,0,0.35)); margin: 0 auto 18px; }
.item-top { display: flex; margin-bottom: 6px; }
.item img { width: 60px; height: 60px; margin-right: 12px; }
.item-text b { font-size: 18px; }
.item-text p { margin: 2px 0; font-size: 14px; }
.stock { font-size: 12px; color: #ffdede; }
.item button { margin-top: auto; width: 100%; padding: 10px; background: #332614; color: #fff; border: none; border-radius: 8px; font-size: 16px; transition: transform .12s ease; }
.item button:active { transform: scale(0.96); }

.price { display: flex; align-items: center; justify-content: center; gap: 6px; }
.price img { width: 18px; height: 18px; object-fit: contain; }

.floating-coin { position: absolute; font-size: 14px; color: lime; pointer-events: none; display: flex; align-items: center; gap: 4px; transition: transform .8s ease-out, opacity .8s ease-out; z-index: 2; }
.floating-coin img { width: 18px; height: 18px; object-fit: contain; }
</style>
</head>
<body>

<div id="app">
  <button id="settingsBtn"><img src="img/settings.png"></button>
  <button id="loginBtn"><img src="img/login.png"></button>
  <button id="shopBtn"><img src="img/shop-icon.png"></button>
  <button id="backBtn"><img src="img/back-icon.png"></button>

  <div id="panels">
    <div id="clickerPanel">
      <div id="counter">
        <span id="counterValue">0</span>
        <img src="img/anti-coin.png">
      </div>

      <div id="clickButtonWrapper">
        <div id="ground"><img src="img/ground.png"></div>
        <button id="clickButton">
          <img id="clickImg" src="img/click1.png">
        </button>
      </div>
    </div>

    <div id="shopPanel">
      <div id="shopPanelInner">
        <div id="items"></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

/* ===== FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAcv5AfJPjUA-RGfcAsUiQwvucSxkJX4F0",
  authDomain: "anti-shop-99f1d.firebaseapp.com",
  databaseURL: "https://anti-shop-99f1d-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "anti-shop-99f1d",
  storageBucket: "anti-shop-99f1d.firebasestorage.app",
  messagingSenderId: "347202416802",
  appId: "1:347202416802:web:2d2df1b819be9da180e7fb"
};

const appFB = initializeApp(firebaseConfig);
const db = getDatabase(appFB);
const auth = getAuth(appFB);
const provider = new GoogleAuthProvider();

/* ===== ПЕРЕМЕННЫЕ ===== */
let userId = localStorage.getItem("userId");
if (!userId) {
  userId = "guest_" + Math.random().toString(36).substring(2, 9);
  localStorage.setItem("userId", userId);
}

let coins = 0;
let clickPower = 1;
let dataLoaded = false;
let lastSavedCoins = 0;

const counterValue = document.getElementById("counterValue");
const itemsBlock = document.getElementById("items");

const shopItems = [
  { id:1, name:'Оторванная пуговица', cost:50, description:'Похожа на глаз игрушки.', property:'+1 за клик', incrementCost:50, img:'img/item-1.png' },
  { id:2, name:'Страшная штука', cost:250, description:'Она пугает.', property:'+10 за клик', power:10, stock:5, img:'img/item-2.png' }
];

/* ===== ЗАГРУЗКА ДАННЫХ ===== */
async function loadData() {
  const userRef = ref(db, "players/" + userId);
  try {
    const snap = await get(userRef);
    if (!snap.exists() || !snap.val()) {
      await set(userRef, { coins: 0, clickPower: 1, shopItems: {} });
      coins = 0; clickPower = 1;
      console.log("создан новый пользователь");
    } else {
      const d = snap.val();
      coins = d.coins ?? 0;
      clickPower = d.clickPower ?? 1;
      lastSavedCoins = coins;
      if (d.shopItems) {
        shopItems.forEach(item => {
          if (d.shopItems[item.id]) {
            item.cost = d.shopItems[item.id].cost ?? item.cost;
            if (item.stock !== undefined)
              item.stock = d.shopItems[item.id].stock ?? item.stock;
          }
        });
      }
    }
  } catch(e){ console.error(e); }
  dataLoaded = true;
  updateUI();
  renderShop();
}

/* ===== СОХРАНЕНИЕ ===== */
function saveData() {
  if (!dataLoaded) return;
  const shopState = {};
  shopItems.forEach(i => {
    shopState[i.id] = { cost: i.cost };
    if (i.stock !== undefined) shopState[i.id].stock = i.stock;
  });
  const userRef = ref(db, "players/" + userId);
  set(userRef, { coins, clickPower, shopItems: shopState });
  lastSavedCoins = coins;
}

/* ===== UI ===== */
function updateUI() {
  counterValue.textContent = coins;
}

/* ===== FLOATING COINS ===== */
function spawnFloatingCoin(x,y,value){
  const el = document.createElement("div");
  el.className = "floating-coin";
  el.style.left = (x-10) + "px";
  el.style.top = (y-10) + "px";
  el.innerHTML = `<img src="img/anti-coin.png">${value}`;
  document.body.appendChild(el);
  requestAnimationFrame(()=>{ el.style.transform="translateY(-60px)"; el.style.opacity="0"; });
  setTimeout(()=> el.remove(), 800);
}

/* ===== КЛИКЕР ===== */
const clickImg = document.getElementById("clickImg");
const clickButton = document.getElementById("clickButton");
function clickAction(x, y){ coins+=clickPower; spawnFloatingCoin(x,y,clickPower); updateUI(); }
clickButton.addEventListener("touchstart",e=>{e.preventDefault();for(const t of e.changedTouches){clickAction(t.clientX,t.clientY);}clickImg.src="img/click2.png";clickImg.style.transform="scale(0.92)";setTimeout(()=>{clickImg.src="img/click1.png";clickImg.style.transform="scale(1)";},150);},{passive:false});
clickButton.onclick=e=>{clickAction(e.clientX,e.clientY);clickImg.src="img/click2.png";clickImg.style.transform="scale(0.92)";setTimeout(()=>{clickImg.src="img/click1.png";clickImg.style.transform="scale(1)";},150);};

/* ===== AUTO-SAVE ===== */
setInterval(()=>{ if(coins!==lastSavedCoins) saveData(); },5000);

/* ===== LOGIN ===== */
const loginBtn = document.getElementById("loginBtn");
loginBtn.onclick = async ()=>{
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    console.log("вход:", user.uid);
    const onlineId = user.uid;
    const localCoins = coins;
    const localPower = clickPower;

    const onlineRef = ref(db, "players/" + onlineId);
    const onlineData = await get(onlineRef);

    if (onlineData.exists()) {
      const d = onlineData.val();
      coins = d.coins ?? 0;
      clickPower = d.clickPower ?? 1;
      console.log("загружен прогресс аккаунта");
    } else {
      await set(onlineRef, { coins: localCoins, clickPower: localPower, shopItems: {} });
      console.log("новый аккаунт — локальный прогресс сохранён");
    }

    localStorage.setItem("userId", onlineId);
    userId = onlineId;
    loginBtn.style.display = "none";
    updateUI();
    saveData();
  } catch(err) {
    console.error("ошибка входа:", err);
  }
};

/* ===== ПАНЕЛИ ===== */
const panels = document.getElementById("panels");
const shopBtn = document.getElementById("shopBtn");
const backBtn = document.getElementById("backBtn");
shopBtn.onclick = ()=>{ panels.style.transform="translateX(-392px)"; shopBtn.style.display="none"; backBtn.style.display="block"; };
backBtn.onclick = ()=>{ panels.style.transform="translateX(0)"; shopBtn.style.display="block"; backBtn.style.display="none"; };

loadData();
</script>
</body>
</html>
