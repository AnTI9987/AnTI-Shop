import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

/* ===== FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDgG3iDWjGKQVIt7GaYFtDpy5MnMZESxVo",
  authDomain: "anti-shop-d6b33.firebaseapp.com",
  databaseURL: "https://anti-shop-d6b33-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "anti-shop-d6b33",
  storageBucket: "anti-shop-d6b33.appspot.com",
  messagingSenderId: "292698259142",
  appId: "1:292698259142:web:6dfffb2ba0972195bd61c7"
};

const appFB = initializeApp(firebaseConfig);
const db = getDatabase(appFB);

/* ===== ПЕРЕМЕННЫЕ ===== */
let userId = localStorage.getItem("userId");
if (!userId) {
  userId = "user_" + Math.random().toString(36).substring(2, 9);
  localStorage.setItem("userId", userId);
}

let coins = 0;
let clickPower = 1;
let dataLoaded = false;

const counterValue = document.getElementById("counterValue");
const itemsBlock = document.getElementById("items");

const shopItems = [
  { id:1, name:'Оторванная пуговица', cost:50, description:'Похожа на глаз игрушки.', property:'+1 за клик', incrementCost:50, img:'img/item-1.png' },
  { id:2, name:'Страшная штука', cost:250, description:'Она пугает.', property:'+10 за клик', power:10, stock:5, img:'img/item-2.png' }
];

/* ===== ЗАГРУЗКА ДАННЫХ ===== */
async function loadData() {
  const userRef = ref(db, "players/" + userId);
  try {
    const snap = await get(userRef);
    if (!snap.exists()) {
      await set(userRef, { coins: 0, clickPower: 1, shopItems: {} });
      console.log("создан новый пользователь");
    } else {
      const d = snap.val();
      coins = d.coins ?? 0;
      clickPower = d.clickPower ?? 1;

      if (d.shopItems) {
        shopItems.forEach(item => {
          if (d.shopItems[item.id]) {
            item.cost = d.shopItems[item.id].cost ?? item.cost;
            if (item.stock !== undefined)
              item.stock = d.shopItems[item.id].stock ?? item.stock;
          }
        });
      }
      console.log("данные загружены:", d);
    }
    dataLoaded = true;
    updateUI();
    renderShop();
  } catch(err) {
    console.error("ошибка загрузки данных:", err);
  }
}

/* ===== СОХРАНЕНИЕ ДАННЫХ ===== */
function saveData() {
  if (!dataLoaded) return;

  const shopState = {};
  shopItems.forEach(i => {
    shopState[i.id] = { cost: i.cost, stock: i.stock };
  });

  const userRef = ref(db, "players/" + userId);
  set(userRef, { coins, clickPower, shopItems: shopState })
    .then(() => console.log("данные успешно сохранены"))
    .catch(err => console.error("ошибка при сохранении:", err));
}

/* ===== АВТОМАТИЧЕСКОЕ СОХРАНЕНИЕ каждые 10 секунд ===== */
setInterval(() => saveData(), 10000); // 10000 мс = 10 секунд

/* ===== ОБНОВЛЕНИЕ UI ===== */
function updateButtonText(item, btn){
  btn.innerHTML = "";

  if (item.stock !== undefined && item.stock <= 0) {
    btn.textContent = "распродано";
    btn.disabled = true;
    return;
  }

  const p = document.createElement("div");
  p.className = "price";
  p.innerHTML = `${item.cost}<img src="img/anti-coin.png">`;
  p.querySelector("img").style.width = "18px";
  p.querySelector("img").style.height = "18px";
  p.querySelector("img").style.objectFit = "contain";
  p.style.color = coins < item.cost ? "#ff3333" : "#fff";
  btn.appendChild(p);
}

function renderShop() {
  itemsBlock.innerHTML = "";
  shopItems.forEach(item => {
    const d = document.createElement("div");
    d.className = "item";
    d.innerHTML = `
      <div class="item-top">
        <img src="${item.img}">
        <div class="item-text">
          <b>${item.name}</b>
          <p>${item.description}</p>
          <p>${item.property}</p>
        </div>
      </div>
    `;

    if (item.stock !== undefined) {
      const s = document.createElement("p");
      s.className = "stock";
      s.textContent = "В наличии: " + item.stock;
      d.appendChild(s);
    }

    const btn = document.createElement("button");
    d.appendChild(btn);
    updateButtonText(item, btn);

    btn.onclick = () => {
      if (!dataLoaded) return;
      if (item.stock !== undefined && item.stock <= 0) return;
      if (coins < item.cost) return;

      coins -= item.cost;

      if (item.id === 1) { clickPower += 1; item.cost += item.incrementCost; }
      if (item.id === 2) { clickPower += item.power; item.cost += 250; item.stock = Math.max(0, item.stock - 1); }

      updateUI();
      updateButtonText(item, btn);
      if (item.stock !== undefined) {
        const st = d.querySelector(".stock");
        st.textContent = item.stock > 0 ? "В наличии: " + item.stock : "";
      }
    };

    itemsBlock.appendChild(d);
  });
}

function updateUI() {
  counterValue.textContent = coins;
  document.querySelectorAll(".item").forEach((el,i)=>{
    updateButtonText(shopItems[i], el.querySelector("button"));
  });
}

/* ===== FLOATING COINS ===== */
function spawnFloatingCoin(x,y,value){
  const el = document.createElement("div");
  el.className = "floating-coin";
  el.style.left = (x-10) + "px";
  el.style.top = (y-10) + "px";
  el.innerHTML = `<img src="img/anti-coin.png">${value}`;
  document.body.appendChild(el);

  requestAnimationFrame(()=>{
    el.style.transform = "translateY(-60px)";
    el.style.opacity = "0";
  });

  setTimeout(()=> el.remove(), 800);
}

/* ===== CLICKER ===== */
const clickImg = document.getElementById("clickImg");
const clickButton = document.getElementById("clickButton");

clickButton.addEventListener("touchstart", e => {
  if (!dataLoaded) return;
  e.preventDefault();
  for (const t of e.changedTouches) {
    coins += clickPower;
    spawnFloatingCoin(t.clientX, t.clientY, clickPower);
  }
  clickImg.src = "img/click2.png";
  clickImg.style.transform = "scale(0.92)";
  setTimeout(()=>{
    clickImg.src = "img/click1.png";
    clickImg.style.transform="scale(1)";
  },150);
  updateUI();
},{ passive:false });

clickButton.onclick = e => {
  if (!dataLoaded) return;
  coins += clickPower;
  spawnFloatingCoin(e.clientX, e.clientY, clickPower);
  clickImg.src = "img/click2.png";
  clickImg.style.transform = "scale(0.92)";
  setTimeout(()=>{
    clickImg.src="img/click1.png";
    clickImg.style.transform="scale(1)";
  },150);
  updateUI();
};

/* ===== PANEL SWITCH ===== */
const panels = document.getElementById("panels");
const shopBtn = document.getElementById("shopBtn");
const backBtn = document.getElementById("backBtn");

shopBtn.onclick = () => {
  panels.style.transform = "translateX(-392px)";
  shopBtn.style.display = "none";
  backBtn.style.display = "block";
};
backBtn.onclick = () => {
  panels.style.transform = "translateX(0)";
  shopBtn.style.display = "block";
  backBtn.style.display = "none";
};

/* ===== ЗАГРУЗКА ПРИ СТАРТЕ ===== */
loadData();
