<script type="module">
window.addEventListener("DOMContentLoaded", () => {

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDgG3iDWjGKQVIt7GaYFtDpy5MnMZESxVo",
  authDomain: "anti-shop-d6b33.firebaseapp.com",
  databaseURL: "https://anti-shop-d6b33-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "anti-shop-d6b33",
  storageBucket: "anti-shop-d6b33.appspot.com",
  messagingSenderId: "292698259142",
  appId: "1:292698259142:web:6dfffb2ba0972195bd61c7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ------------------------------
// ПОЛЬЗОВАТЕЛЬ
// ------------------------------
let userId = localStorage.getItem("userId");
if (!userId) {
  userId = "user_" + Math.random().toString(36).substr(2, 9);
  localStorage.setItem("userId", userId);
}

let coins = 0;
let clickPower = 1;
let dataLoaded = false;

// ------------------------------
// ЭЛЕМЕНТЫ
// ------------------------------
const counterValue = document.getElementById('counterValue');
const clickImg = document.getElementById('clickImg');
const clickButton = document.getElementById('clickButton');
const itemsBlock = document.getElementById('items');
const clickerPanel = document.getElementById('clickerPanel');
const shopPanel = document.getElementById('shopPanel');
const clickerTab = document.getElementById('clickerTab');
const shopTab = document.getElementById('shopTab');

// ------------------------------
// ТАБЫ
// ------------------------------
clickerTab.addEventListener('click', () => {
  clickerPanel.style.display = 'block';
  shopPanel.style.display = 'none';
  clickerTab.classList.add('active');
  shopTab.classList.remove('active');
});

shopTab.addEventListener('click', () => {
  clickerPanel.style.display = 'none';
  shopPanel.style.display = 'block';
  shopTab.classList.add('active');
  clickerTab.classList.remove('active');
});

// ------------------------------
// МАГАЗИН
// ------------------------------
const shopItems = [
  { id:1, name:'Оторванная пуговица', cost:50, description:'Кажется, эта пуговица служила подобием глаза для плюшевой игрушки.', property:'Прибавляет +1 к заработку за клик', incrementCost:50, img:'img/item-1.png' },
  { id:2, name:'Страшная штука', cost:250, description:'Оно пугает.', property:'Прибавляет +10 к заработку за клик', power:10, stock:5, img:'img/item-2.png' }
];

async function loadData() {
  const snapshot = await get(ref(db, "players/" + userId));
  if (snapshot.exists()) {
    const data = snapshot.val();

    coins = data.coins ?? 0;
    clickPower = data.clickPower ?? 1;

    if (data.shopItems) {
      shopItems.forEach(item => {
        if (data.shopItems[item.id]) {
          item.stock = data.shopItems[item.id].stock ?? item.stock;
          if (item.id === 1)
            item.cost = data.shopItems[item.id].cost ?? item.cost;
        }
      });
    }
  }

  dataLoaded = true;
  updateUI();
  renderShop();   // ← теперь вызываем после загрузки
}

function saveData() {
  const shopData = {};
  shopItems.forEach(item => {
    shopData[item.id] = {
      stock: item.stock ?? null,
      cost: item.cost ?? null
    };
  });

  update(ref(db, "players/" + userId), {
    coins: coins,
    clickPower: clickPower,
    shopItems: shopData
  });
}

function renderShop() {
  if (!itemsBlock) return;

  itemsBlock.innerHTML = '';
  shopItems.forEach(item => {
    const div = document.createElement('div');
    div.className = 'item';

    const button = document.createElement('button');
    const stockEl = document.createElement('p');
    stockEl.className = 'stock';

    if (item.stock !== undefined)
      stockEl.textContent = `В наличии: ${item.stock}`;

    const updateButtonText = () => {
      if (item.stock !== undefined && item.stock <= 0) {
        button.innerHTML = 'распродано';
        button.style.color = 'gray';
        stockEl.textContent = '';
      } else {
        button.innerHTML =
          `<div class="price">Купить за ${item.cost}<img src="img/anti-coin.png"></div>`;
        button.style.fontWeight = 'bold';
      }
    };

    button.addEventListener('click', () => {
      if (!dataLoaded) return;

      if ((item.stock === undefined || item.stock > 0) && coins >= item.cost) {
        coins -= item.cost;

        if (item.id === 1) {
          clickPower += 1;
          item.cost += item.incrementCost;
        }

        if (item.id === 2 && item.stock > 0) {
          clickPower += item.power;
          item.stock -= 1;
        }

        updateUI();
        saveData();
        updateButtonText();
      }
    });

    div.innerHTML =
    `<div class="item-top">
        <img src="${item.img}">
        <div class="item-text">
          <b>${item.name}</b>
          <p>${item.description}</p>
          <p class='property'>${item.property}</p>
        </div>
     </div>`;

    if (item.stock !== undefined) div.appendChild(stockEl);
    div.appendChild(button);
    itemsBlock.appendChild(div);
    updateButtonText();
  });

  updateUI();
}

// ------------------------------
// АНИМАЦИЯ МОНЕТ
// ------------------------------
function spawnFloatingCoin(x, y, value) {
  const floatEl = document.createElement('div');
  floatEl.className = 'floating-coin';
  floatEl.style.left = x + 'px';
  floatEl.style.top = y + 'px';
  floatEl.innerHTML = `${value}<img src="img/anti-coin.png" width="14" height="14">`;

  document.body.appendChild(floatEl);

  requestAnimationFrame(() => {
    floatEl.style.transform = 'translateY(-60px)';
    floatEl.style.opacity = '0';
  });

  setTimeout(() => floatEl.remove(), 800);
}

// ------------------------------
// МУЛЬТИ ТАЧ CLICK
// ------------------------------
clickButton.addEventListener('touchstart', e => {
  if (!dataLoaded) return;

  e.preventDefault();

  const touches = e.touches.length;
  const gain = clickPower * touches;

  coins += gain;

  const rect = clickImg.getBoundingClientRect();
  const x = rect.left + rect.width / 2 - 7;
  const y = rect.top;

  spawnFloatingCoin(x, y, gain);

  clickImg.src = "img/click2.png";
  clickImg.style.transform = "scale(0.9)";
  setTimeout(() => {
    clickImg.src = "img/click1.png";
    clickImg.style.transform = "scale(1)";
  }, 150);

  updateUI();
  saveData();
}, { passive:false });

loadData();
clickerPanel.style.display = "block";

}); // DOMContentLoaded END
</script>
